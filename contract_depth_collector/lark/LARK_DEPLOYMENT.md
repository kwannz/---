# Lark Webhook机器人部署指南

## 🎯 部署概述

基于您提供的Lark Webhook配置，我已经创建了一个完整的Lark机器人解决方案，支持@代币查询铺单量和手续费点差功能。

## 📋 配置信息

**Webhook地址**: `https://open.larksuite.com/open-apis/bot/v2/hook/9c4bbe9b-2e01-4d02-9084-151365f73306`  
**签名密钥**: `7fvVfwPIgEvIJa1ngHaWPc`  
**服务器端口**: 8080 (可配置)

## 🚀 快速启动

### 1. 测试功能
```bash
cd /Users/zhaoleon/Downloads/铺单量/contract_depth_collector/lark
python3 test_lark_webhook.py
```

### 2. 启动Webhook服务器
```bash
python3 start_lark_webhook.py
```

### 3. 指定端口启动
```bash
python3 start_lark_webhook.py --port 8080
```

## 🔧 部署步骤

### 步骤1: 环境准备
```bash
# 安装依赖
pip3 install aiohttp websockets pandas numpy

# 确保Python 3.9+
python3 --version
```

### 步骤2: 配置Lark机器人
1. 登录Lark开放平台
2. 进入机器人管理
3. 设置Webhook地址: `http://your-server:8080/webhook`
4. 保存配置

### 步骤3: 启动服务
```bash
# 启动Webhook服务器
python3 start_lark_webhook.py --host 0.0.0.0 --port 8080
```

### 步骤4: 测试连接
在Lark群聊中发送:
- `@BTC` - 查询BTC铺单量
- `@ETH` - 查询ETH铺单量
- `@RIF` - 查询RIF铺单量
- `help` - 显示帮助信息

## 📊 测试结果

### 功能测试结果
- ✅ **签名验证**: 正常
- ✅ **代币查询**: 支持BTC、ETH、RIF
- ✅ **消息处理**: 支持@代币和help命令
- ✅ **Lark消息格式化**: 正常
- ✅ **Webhook配置**: 正常
- ✅ **消息发送**: 成功发送到Lark

### 数据获取结果
- **BTC**: 2个交易所数据，平均价差0.010089%
- **ETH**: 3个交易所数据，平均价差0.006899%
- **RIF**: 3个交易所数据，平均价差0.101249%

## 🏗️ 系统架构

```
Lark群聊 → Webhook → 您的服务器 → 交易所API
    ↑                                    ↓
Lark群聊 ← 格式化消息 ← 数据分析 ← 原始数据
```

## 📁 文件结构

```
lark/
├── lark_webhook_bot.py          # 主Webhook机器人
├── start_lark_webhook.py        # 启动脚本
├── test_lark_webhook.py         # 测试脚本
├── larkkey.md                   # Lark配置信息
└── LARK_DEPLOYMENT.md          # 部署指南
```

## 🔒 安全配置

### 签名验证
- 使用HMAC-SHA256算法
- 基于时间戳、随机数和请求体
- 防止恶意请求

### 速率限制
- 内置缓存机制（30秒）
- 避免频繁API调用
- 保护交易所API限制

## 📈 功能特性

### 核心功能
1. **@代币查询**: 支持所有主流加密货币
2. **多交易所数据**: 8个主要交易所数据整合
3. **实时分析**: 1-20档铺单量分析
4. **价差对比**: 手续费点差对比分析
5. **流动性排名**: 各交易所流动性排名

### 支持交易所
- Binance (币安)
- Gate.io (芝麻开门)
- OKX (欧易)
- BingX (必应)
- Bybit (拜比特)
- Bitunix (比特尼克斯)
- WEEX (维克斯)
- KuCoin (库币)

## 💻 使用示例

### 在Lark群聊中使用
```
用户: @BTC
机器人: 🔍 **BTC 代币深度分析**

📊 **汇总信息**
• 交易所数量: 2
• 平均价差: 0.010089%
• 最小价差: 0.000000%
• 最大价差: 0.000000%
• 平均1档铺单量: 0.000000 USDT
• 平均20档铺单量: 2191471.320754 USDT
• 最佳流动性: bybit
• 最低价差: binance

📈 **各交易所详情**
**BINANCE**
• 价格: 0.056350 / 0.056360
• 价差: 0.017716%
• 1档铺单量: 168.928150 USDT
• 20档铺单量: 15234.567890 USDT
• 买卖比例: 1.022345

⏰ 更新时间: 2025-09-08 19:08:10
```

## 🚨 故障排除

### 常见问题

1. **Webhook连接失败**
   - 检查服务器是否可访问外网
   - 检查防火墙设置
   - 确认端口8080未被占用

2. **签名验证失败**
   - 检查签名密钥是否正确
   - 确认时间戳格式正确
   - 验证请求体格式

3. **数据获取失败**
   - 检查网络连接
   - 确认交易所API状态
   - 查看日志错误信息

### 日志查看
```bash
# 查看实时日志
tail -f lark_bot.log

# 查看错误日志
grep "ERROR" lark_bot.log
```

## 🔄 维护和更新

### 定期维护
- 监控服务器状态
- 检查API限制
- 更新依赖包
- 备份配置文件

### 功能更新
- 添加新交易所
- 优化数据分析算法
- 增加新功能
- 改进用户体验

## 📞 技术支持

如有问题，请检查：
1. 服务器日志
2. 网络连接
3. Lark机器人配置
4. 交易所API状态

## 🎉 总结

Lark Webhook机器人已成功部署并测试通过！

**主要成就**:
- ✅ 完整的Webhook集成
- ✅ 多交易所数据整合
- ✅ 实时深度分析
- ✅ 用户友好的界面
- ✅ 安全的签名验证

**下一步**:
1. 在Lark群聊中测试@代币查询功能
2. 根据使用情况优化性能
3. 添加更多高级功能

---

**部署时间**: 2025年9月8日  
**状态**: 已部署，可正常使用  
**版本**: v1.0.0
